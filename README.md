# FactuMarket S.A. - Sistema de Facturaci√≥n Electr√≥nica

Sistema completo de facturaci√≥n electr√≥nica basado en microservicios, construido con Ruby on Rails, implementando Clean Architecture, patr√≥n MVC y arquitectura orientada a eventos.

> **Soluci√≥n de Prueba T√©cnica** para la posici√≥n de Backend Developer en Double V Partners NYX

## üöÄ Inicio R√°pido

```bash
# Clonar el repositorio
git clone <repository-url>
cd factumarket-microservices

# Iniciar todos los servicios con Docker
docker-compose up -d --build

# Esperar a que los servicios est√©n listos (2-3 minutos)
# Verificar que los 6 contenedores est√©n corriendo
docker ps

# ¬°Listo! Visita los servicios:
# - Customer Service: http://localhost:3001
# - Invoice Service: http://localhost:3002
# - Audit Service: http://localhost:3003
# - RabbitMQ Management: http://localhost:15672 (guest/guest)
```

Para instrucciones detalladas de prueba, consulta [QUICK_START.md](QUICK_START.md) o [MANUAL_TESTING_GUIDE.md](MANUAL_TESTING_GUIDE.md).

## üìã Tabla de Contenidos

- [Descripci√≥n del Proyecto](#descripci√≥n-del-proyecto)
- [Arquitectura](#arquitectura)
- [Tecnolog√≠as Utilizadas](#tecnolog√≠as-utilizadas)
- [Microservicios](#microservicios)
- [Requisitos Previos](#requisitos-previos)
- [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
- [Ejecuci√≥n con Docker](#ejecuci√≥n-con-docker)
- [API Endpoints](#api-endpoints)
- [Clean Architecture](#clean-architecture)
- [Pruebas](#pruebas)
- [Eventos de Auditor√≠a](#eventos-de-auditor√≠a)
- [Estructura del Repositorio](#estructura-del-repositorio)
- [Autor](#autor)

## üìñ Descripci√≥n del Proyecto

FactuMarket S.A. necesita modernizar su sistema de facturaci√≥n electr√≥nica. Este proyecto implementa una soluci√≥n basada en microservicios que permite:

- ‚úÖ Registro y gesti√≥n de clientes
- ‚úÖ Emisi√≥n de facturas electr√≥nicas con validaciones de negocio
- ‚úÖ Almacenamiento transaccional en PostgreSQL
- ‚úÖ Registro de eventos de auditor√≠a en MongoDB (NoSQL)
- ‚úÖ Comunicaci√≥n as√≠ncrona mediante RabbitMQ
- ‚úÖ Autenticaci√≥n con JWT
- ‚úÖ Trazabilidad completa de operaciones

## üèóÔ∏è Arquitectura

### Diagrama de Alto Nivel

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CLIENTE                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ (HTTP/JSON + JWT)
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    API GATEWAY (Opcional)                    ‚îÇ
‚îÇ                  JWT Authentication Layer                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                  ‚îÇ                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Customer     ‚îÇ  ‚îÇ   Invoice    ‚îÇ  ‚îÇ    Audit     ‚îÇ
‚îÇ   Service      ‚îÇ  ‚îÇ   Service    ‚îÇ  ‚îÇ   Service    ‚îÇ
‚îÇ  (Rails API)   ‚îÇ  ‚îÇ  (Rails API) ‚îÇ  ‚îÇ  (Rails API) ‚îÇ
‚îÇ   MVC Pattern  ‚îÇ  ‚îÇ Clean Arch ‚úì ‚îÇ  ‚îÇ  MVC Pattern ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                  ‚îÇ                ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL    ‚îÇ  ‚îÇ  PostgreSQL  ‚îÇ  ‚îÇ  MongoDB     ‚îÇ
‚îÇ  (customers)   ‚îÇ  ‚îÇ  (invoices)  ‚îÇ  ‚îÇ(audit_events)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                  ‚îÇ                ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ   RabbitMQ      ‚îÇ
                  ‚îÇ  (Event Bus)    ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Comunicaci√≥n entre Servicios

- **S√≠ncrona (REST/HTTP)**: Invoice Service ‚Üí Customer Service (validaci√≥n de cliente)
- **As√≠ncrona (RabbitMQ)**: Todos los servicios publican eventos ‚Üí Audit Service consume

### Bases de Datos

- **PostgreSQL**: Datos transaccionales (clientes y facturas)
- **MongoDB**: Logs de auditor√≠a y eventos

## üõ†Ô∏è Tecnolog√≠as Utilizadas

| Componente | Tecnolog√≠a |
|------------|------------|
| Framework | Ruby on Rails 8.0 (API mode) |
| Lenguaje | Ruby 3.2+ |
| DB Transaccional | PostgreSQL 16 (via pg adapter) |
| DB Auditor√≠a | MongoDB 7.0 (via mongoid) |
| Message Queue | RabbitMQ 3.12 (via bunny) |
| Autenticaci√≥n | JWT |
| HTTP Client | Faraday |
| Testing | RSpec |
| Containerizaci√≥n | Docker & Docker Compose |

## üî¨ Microservicios

### 1. Customer Service (Puerto 3001)

**Responsabilidad**: Gesti√≥n de clientes

**Endpoints**:
- `POST /clientes` - Registrar cliente
- `GET /clientes/:id` - Obtener cliente por ID
- `GET /clientes` - Listar clientes

**Base de Datos**: PostgreSQL (tabla `customers`)

**Arquitectura**: MVC tradicional

**Eventos Publicados**: `customer.created`, `customer.fetched`, `customer.listed`

### 2. Invoice Service (Puerto 3002)

**Responsabilidad**: Creaci√≥n y gesti√≥n de facturas electr√≥nicas

**Endpoints**:
- `POST /facturas` - Crear factura
- `GET /facturas/:id` - Obtener factura por ID
- `GET /facturas?fechaInicio=XX&fechaFin=YY` - Listar facturas por rango de fechas

**Base de Datos**: PostgreSQL (tabla `invoices`)

**Arquitectura**: **Clean Architecture** (ver secci√≥n detallada abajo)

**Validaciones de Negocio**:
- Cliente debe existir (consulta a Customer Service)
- Monto > 0
- Fecha de emisi√≥n v√°lida (no futura)

**Eventos Publicados**: `invoice.created`, `invoice.fetched`, `invoice.listed`, `invoice.error`

### 3. Audit Service (Puerto 3003)

**Responsabilidad**: Registro y consulta de eventos de auditor√≠a

**Endpoints**:
- `GET /auditoria/:factura_id` - Consultar eventos de una factura
- `GET /auditoria?service=XX&entity_type=YY` - Listar eventos con filtros

**Base de Datos**: MongoDB (colecci√≥n `audit_events`)

**Arquitectura**: MVC + Event Consumer (RabbitMQ)

**Eventos Consumidos**: `customer.*`, `invoice.*`

## üì¶ Requisitos Previos

- Docker 20.10+
- Docker Compose 1.29+
- (Opcional) Ruby 3.2+ si desea ejecutar localmente sin Docker

## üöÄ Instalaci√≥n y Configuraci√≥n

### Opci√≥n 1: Ejecuci√≥n con Docker (Recomendado)

1. **Clonar el repositorio**:
```bash
git clone <repository-url>
cd factumarket-microservices
```

2. **Levantar todos los servicios con Docker Compose**:
```bash
docker-compose up --build
```

Esto iniciar√°:
- PostgreSQL (puerto 5432)
- MongoDB (puerto 27017)
- RabbitMQ (puerto 5672, Management UI: 15672)
- Customer Service (puerto 3001)
- Invoice Service (puerto 3002)
- Audit Service (puerto 3003)

3. **Esperar a que los servicios est√©n listos**:

Los servicios tienen health checks configurados. Espera a ver:
```
factumarket-customer-service | => Booting Puma
factumarket-invoice-service | => Booting Puma
factumarket-audit-service | => Booting Puma
```

4. **Verificar servicios**:
```bash
curl http://localhost:3001/up  # Customer Service
curl http://localhost:3002/up  # Invoice Service
curl http://localhost:3003/up  # Audit Service
```

### Opci√≥n 2: Ejecuci√≥n Local (Sin Docker)

#### Prerrequisitos
- PostgreSQL instalado localmente o accesible
- MongoDB instalado
- RabbitMQ instalado

#### Pasos

1. **Configurar variables de entorno** para cada servicio:

Customer Service (`.env`):
```
POSTGRES_HOST=localhost
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
RABBITMQ_HOST=localhost
JWT_SECRET_KEY=factumarket_secret_key_2025
```

Invoice Service (`.env`):
```
POSTGRES_HOST=localhost
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
CUSTOMER_SERVICE_URL=http://localhost:3001
RABBITMQ_HOST=localhost
JWT_SECRET_KEY=factumarket_secret_key_2025
```

Audit Service (`.env`):
```
MONGODB_HOST=localhost
RABBITMQ_HOST=localhost
JWT_SECRET_KEY=factumarket_secret_key_2025
```

2. **Instalar dependencias y ejecutar migraciones**:

```bash
# Customer Service
cd customer-service
bundle install
rails db:create db:migrate
rails server -p 3001

# Invoice Service (nueva terminal)
cd invoice-service
bundle install
rails db:create db:migrate
rails server -p 3002

# Audit Service (nueva terminal)
cd audit-service
bundle install
rails server -p 3003

# Event Consumer (nueva terminal)
cd audit-service
rails runner 'EventConsumer.start'
```

## üì° API Endpoints

### Autenticaci√≥n

Todos los endpoints est√°n protegidos con JWT. Para obtener un token (simplificado para la demo):

```bash
# Generar token JWT
irb
require 'jwt'
payload = { user_id: 1, email: 'admin@factumarket.com' }
secret = 'factumarket_secret_key_2025'
token = JWT.encode(payload, secret, 'HS256')
puts token
```

Incluir en todas las peticiones:
```
Authorization: Bearer <token>
```

### Customer Service

#### Registrar Cliente
```bash
curl -X POST http://localhost:3001/clientes \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "customer": {
      "name": "Empresa ABC S.A.S",
      "identification": "901234567-8",
      "email": "contacto@empresaabc.com",
      "address": "Calle 123 #45-67, Bogot√°"
    }
  }'
```

#### Obtener Cliente
```bash
curl -X GET http://localhost:3001/clientes/1 \
  -H "Authorization: Bearer <token>"
```

#### Listar Clientes
```bash
curl -X GET http://localhost:3001/clientes \
  -H "Authorization: Bearer <token>"
```

### Invoice Service

#### Crear Factura
```bash
curl -X POST http://localhost:3002/facturas \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "invoice": {
      "customer_id": 1,
      "amount": 1500000.50,
      "emission_date": "2025-10-20"
    }
  }'
```

#### Obtener Factura
```bash
curl -X GET http://localhost:3002/facturas/1 \
  -H "Authorization: Bearer <token>"
```

#### Listar Facturas por Rango de Fechas
```bash
curl -X GET "http://localhost:3002/facturas?fechaInicio=2025-10-01&fechaFin=2025-10-31" \
  -H "Authorization: Bearer <token>"
```

### Audit Service

#### Obtener Auditor√≠a de una Factura
```bash
curl -X GET http://localhost:3003/auditoria/1 \
  -H "Authorization: Bearer <token>"
```

#### Listar Todos los Eventos de Auditor√≠a
```bash
curl -X GET "http://localhost:3003/auditoria?service=invoice_service&entity_type=Invoice" \
  -H "Authorization: Bearer <token>"
```

## üèõÔ∏è Clean Architecture

El **Invoice Service** implementa Clean Architecture completa con separaci√≥n de capas:

### Estructura de Carpetas

```
invoice-service/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ domain/                    # Capa de Dominio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ invoice.rb         # Entidad de dominio (l√≥gica de negocio pura)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ invoice_repository.rb  # Interfaz del repositorio
‚îÇ   ‚îú‚îÄ‚îÄ application/               # Capa de Aplicaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ use_cases/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create_invoice.rb  # Caso de uso: Crear factura
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get_invoice.rb     # Caso de uso: Obtener factura
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ list_invoices.rb   # Caso de uso: Listar facturas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ customer_validator.rb  # Interfaz para validar cliente
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/            # Capa de Infraestructura
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ persistence/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ postgresql_invoice_repository.rb  # Implementaci√≥n PostgreSQL
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ http/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ customer_http_validator.rb    # Cliente HTTP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ messaging/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ rabbitmq_event_publisher.rb   # Publisher RabbitMQ
‚îÇ   ‚îú‚îÄ‚îÄ controllers/               # Capa de Interface Adapters (MVC)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ facturas_controller.rb # Controlador Rails
‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ       ‚îî‚îÄ‚îÄ invoice_model.rb       # ActiveRecord model (solo persistencia)
```

### Principios Aplicados

1. **Dependency Inversion**: Las capas internas (dominio) no dependen de las externas (infraestructura)
2. **Single Responsibility**: Cada clase tiene una √∫nica responsabilidad
3. **Separation of Concerns**: L√≥gica de negocio separada de frameworks y detalles de implementaci√≥n
4. **Testability**: L√≥gica de dominio puede probarse sin Rails, DB o HTTP

### Flujo de Ejecuci√≥n

```
HTTP Request
    ‚Üì
FacturasController (Interface Adapters)
    ‚Üì
CreateInvoice Use Case (Application Layer)
    ‚Üì
Invoice Entity (Domain Layer) ‚Üê Validaciones de negocio
    ‚Üì
PostgresqlInvoiceRepository (Infrastructure Layer)
    ‚Üì
PostgreSQL Database
```

### Inversi√≥n de Dependencias

```ruby
# Domain define la interfaz
class InvoiceRepository
  def save(invoice_entity)
    raise NotImplementedError
  end
end

# Infrastructure implementa la interfaz
class PostgresqlInvoiceRepository < InvoiceRepository
  def save(invoice_entity)
    # Implementaci√≥n con ActiveRecord
  end
end

# Use Case recibe la dependencia inyectada
class CreateInvoice
  def initialize(invoice_repository:)
    @invoice_repository = invoice_repository
  end
end
```

## üß™ Pruebas

### Ejecutar Tests de Dominio (Invoice Service)

```bash
cd invoice-service
bundle exec rspec spec/domain/entities/invoice_spec.rb
bundle exec rspec spec/application/use_cases/create_invoice_spec.rb
```

### Cobertura de Tests

- ‚úÖ Validaci√≥n de monto positivo
- ‚úÖ Validaci√≥n de fecha de emisi√≥n
- ‚úÖ C√°lculo de impuestos (19% IVA)
- ‚úÖ Reglas de negocio (factura cancelable)
- ‚úÖ Flujo completo de creaci√≥n de factura
- ‚úÖ Manejo de errores

## üìä Eventos de Auditor√≠a

Cada operaci√≥n en Customer Service e Invoice Service genera eventos que se almacenan en MongoDB:

### Estructura de Evento

```json
{
  "event_type": "invoice.created",
  "service": "invoice_service",
  "entity_type": "Invoice",
  "entity_id": 123,
  "timestamp": "2025-10-20T10:30:00Z",
  "http_method": "POST",
  "endpoint": "/facturas",
  "metadata": {
    "id": 123,
    "customer_id": 456,
    "amount": 1500000.50,
    "emission_date": "2025-10-20",
    "status": "pending"
  }
}
```

### Tipos de Eventos

- `customer.created` - Cliente creado
- `customer.fetched` - Cliente consultado
- `customer.listed` - Clientes listados
- `invoice.created` - Factura creada
- `invoice.fetched` - Factura consultada
- `invoice.listed` - Facturas listadas
- `invoice.error` - Error en operaci√≥n de factura

## üîê Seguridad

- **JWT Authentication**: Todos los endpoints requieren autenticaci√≥n
- **Secrets Management**: Variables de entorno para credenciales
- **CORS**: Configurado para APIs
- **Validaciones**: A nivel de dominio, aplicaci√≥n y base de datos

## üìà Escalabilidad

- **Microservicios independientes**: Cada servicio puede escalar individualmente
- **Bases de datos separadas**: No hay punto √∫nico de falla
- **Event-driven**: Comunicaci√≥n as√≠ncrona reduce acoplamiento
- **Stateless**: Servicios sin estado facilitan balanceo de carga

## üêõ Troubleshooting

### PostgreSQL no se conecta
```bash
# Verificar que PostgreSQL est√© listo
docker logs factumarket-postgres

# Verificar conexi√≥n
docker exec -it factumarket-postgres psql -U postgres -c "\l"
```

### RabbitMQ no recibe eventos
```bash
# Verificar management UI
open http://localhost:15672
# user: guest, password: guest

# Ver exchanges y queues
```

### MongoDB no conecta
```bash
docker exec -it factumarket-mongodb mongosh
# Verificar que la base est√© creada
show dbs
```

## üìù Notas Adicionales

- Los servicios est√°n configurados para reiniciar autom√°ticamente en caso de fallo
- Los datos persisten en vol√∫menes de Docker
- El Event Consumer corre en el mismo contenedor que Audit Service
- JWT secret key debe cambiarse en producci√≥n

## üìÇ Estructura del Repositorio

```
factumarket-microservices/
‚îú‚îÄ‚îÄ .git/                           # Repositorio Git
‚îú‚îÄ‚îÄ .gitignore                      # Archivos ignorados por Git
‚îú‚îÄ‚îÄ README.md                       # Este archivo - Documentaci√≥n principal
‚îú‚îÄ‚îÄ QUICK_START.md                  # Gu√≠a r√°pida de inicio (5 minutos)
‚îú‚îÄ‚îÄ MANUAL_TESTING_GUIDE.md         # Gu√≠a completa de pruebas manuales (68 casos)
‚îú‚îÄ‚îÄ TESTING_CHECKLIST.md            # Checklist interactivo de pruebas
‚îú‚îÄ‚îÄ run_tests.sh                    # Script automatizado de pruebas
‚îú‚îÄ‚îÄ docker-compose.yml              # Orquestaci√≥n de todos los servicios
‚îÇ
‚îú‚îÄ‚îÄ customer-service/               # Microservicio de Clientes
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/            # Controladores MVC
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ clientes_controller.rb
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/                 # Modelos MVC
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ customer.rb
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ concerns/               # JWT Authentication
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.yml            # Configuraci√≥n PostgreSQL
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.rb               # Rutas API REST
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrate/                # Migraciones de base de datos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seeds.rb                # Datos de prueba
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ event_publisher.rb      # Publicador de eventos RabbitMQ
‚îÇ   ‚îú‚îÄ‚îÄ Gemfile                     # Dependencias Ruby
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile                  # Imagen Docker
‚îÇ
‚îú‚îÄ‚îÄ invoice-service/                # Microservicio de Facturas (Clean Architecture)
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/                 # üèõÔ∏è Capa de Dominio (Clean Architecture)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ invoice.rb      # Entidad con l√≥gica de negocio pura
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ invoice_repository.rb  # Interfaz del repositorio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application/            # üéØ Capa de Aplicaci√≥n (Clean Architecture)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ use_cases/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create_invoice.rb     # Caso de uso: Crear factura
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get_invoice.rb        # Caso de uso: Obtener factura
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ list_invoices.rb      # Caso de uso: Listar facturas
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ customer_validator.rb  # Interfaz validador
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/         # üîß Capa de Infraestructura (Clean Architecture)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ persistence/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ oracle_invoice_repository.rb  # Implementaci√≥n repositorio
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ http/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ customer_http_validator.rb    # Cliente HTTP
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ messaging/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ rabbitmq_event_publisher.rb   # Publisher RabbitMQ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/            # üåê Capa de Interface (MVC)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ facturas_controller.rb
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ invoice_model.rb    # ActiveRecord (solo persistencia)
‚îÇ   ‚îú‚îÄ‚îÄ spec/                       # üß™ Pruebas Unitarias RSpec
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ invoice_spec.rb # Tests de entidad de dominio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ application/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ use_cases/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ create_invoice_spec.rb  # Tests de caso de uso
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.yml            # Configuraci√≥n PostgreSQL
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.rb               # Rutas API REST
‚îÇ   ‚îú‚îÄ‚îÄ db/migrate/                 # Migraciones de base de datos
‚îÇ   ‚îú‚îÄ‚îÄ Gemfile                     # Dependencias Ruby
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile                  # Imagen Docker
‚îÇ
‚îú‚îÄ‚îÄ audit-service/                  # Microservicio de Auditor√≠a
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/            # Controladores MVC
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auditoria_controller.rb
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models/                 # Modelos Mongoid (MongoDB)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ audit_event.rb
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mongoid.yml             # Configuraci√≥n MongoDB
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ initializers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mongoid.rb          # Inicializaci√≥n Mongoid
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes.rb               # Rutas API REST
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ event_consumer.rb       # Consumidor de eventos RabbitMQ
‚îÇ   ‚îú‚îÄ‚îÄ Gemfile                     # Dependencias Ruby
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile                  # Imagen Docker
‚îÇ
‚îî‚îÄ‚îÄ docs/                           # (Impl√≠cito en archivos .md)
    ‚îú‚îÄ‚îÄ Arquitectura y dise√±o       # README.md
    ‚îú‚îÄ‚îÄ Gu√≠a r√°pida                 # QUICK_START.md
    ‚îú‚îÄ‚îÄ Pruebas manuales            # MANUAL_TESTING_GUIDE.md
    ‚îî‚îÄ‚îÄ Checklist de pruebas        # TESTING_CHECKLIST.md
```

### Archivos Clave

| Archivo | Descripci√≥n |
|---------|-------------|
| `docker-compose.yml` | Orquestaci√≥n completa de los 6 servicios (PostgreSQL, MongoDB, RabbitMQ, Customer, Invoice, Audit) |
| `README.md` | Documentaci√≥n t√©cnica completa con arquitectura, APIs y configuraci√≥n |
| `QUICK_START.md` | Gu√≠a para levantar el sistema en 5 minutos con ejemplos de uso |
| `MANUAL_TESTING_GUIDE.md` | 68 casos de prueba detallados paso a paso |
| `TESTING_CHECKLIST.md` | Checklist interactivo para verificar todos los componentes |
| `run_tests.sh` | Script bash para ejecutar todas las pruebas autom√°ticamente |

### Principios Arquitect√≥nicos Aplicados

- **Microservicios**: 3 servicios independientes con bases de datos separadas
- **Clean Architecture**: Implementada en Invoice Service con 4 capas bien definidas
- **MVC Pattern**: Controllers, Models, y Views (JSON) en todos los servicios
- **Event-Driven**: Comunicaci√≥n as√≠ncrona mediante RabbitMQ
- **Dependency Injection**: Inyecci√≥n de dependencias en casos de uso
- **Repository Pattern**: Abstracci√≥n de persistencia en capa de dominio
- **SOLID Principles**: Separaci√≥n de responsabilidades y inversi√≥n de dependencias

## üë• Autor

**Daniel E. Londo√±o**
Backend Developer
üìß daniel.esloh@gmail.com

Prueba T√©cnica para Double V Partners NYX - Octubre 2025

## üìÑ Licencia

Este proyecto es parte de una prueba t√©cnica para Double V Partners NYX.
